import pandas as pd
import re
import os

def parse_restaurants_from_txt(file_path):
    """
    TXT íŒŒì¼ì—ì„œ ë ˆìŠ¤í† ë‘ ì •ë³´ë¥¼ ì½ê³  Pandas ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    """
    with open(file_path, "r", encoding="utf-8") as file:
        data = file.read()
    
    # ë ˆìŠ¤í† ë‘ ì •ë³´ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸
    restaurants = []
    
    # ë ˆìŠ¤í† ë‘ ì •ë³´ë¥¼ ì •ê·œ í‘œí˜„ì‹ì„ ì´ìš©í•´ ì¶”ì¶œ
    pattern = re.compile(r'ì´ë¦„: (.*?)\nì£¼ì†Œ: (.*?)\ní‰ì : (.*?)\nì£¼ìš” ë¦¬ë·°:(.*?)\n={20,}', re.DOTALL)
    
    matches = pattern.findall(data)
    
    for match in matches:
        name, address, rating, reviews = match
        
        # ê°œë³„ ë¦¬ë·° ì •ë³´ ì¶”ì¶œ
        review_pattern = re.compile(r'ì‘ì„±ì: (.*?)\ní‰ì : (\d+)\në¦¬ë·° ë‚´ìš©: (.*?)\n', re.DOTALL)
        review_matches = review_pattern.findall(reviews)
        
        extracted_reviews = []
        for reviewer, score, content in review_matches:
            extracted_reviews.append(f"{reviewer}({score}ì ): {content.strip()}")

        review_text = " | ".join(extracted_reviews)
        
        # ë¦¬ìŠ¤íŠ¸ì— ë ˆìŠ¤í† ë‘ ì •ë³´ ì¶”ê°€
        restaurants.append([name, address, rating, review_text])
    
    # Pandas ë°ì´í„°í”„ë ˆì„ ìƒì„±
    df = pd.DataFrame(restaurants, columns=["ì´ë¦„", "ì£¼ì†Œ", "í‰ì ", "ì£¼ìš” ë¦¬ë·°"])
    
    return df

def preprocess_query(query):
    """
    ì‚¬ìš©ìì˜ ì§ˆë¬¸ì—ì„œ ë ˆìŠ¤í† ë‘ ì´ë¦„ì„ ì¶”ì¶œí•˜ì—¬ ê²€ìƒ‰ ìµœì í™”
    """
    query = re.sub(r"[^ê°€-í£a-zA-Z0-9 ]", "", query)  # íŠ¹ìˆ˜ë¬¸ì ì œê±° (ì˜ˆ: ?, !, @ ë“±)
    
    # ë¶ˆí•„ìš”í•œ ì§ˆë¬¸ íŒ¨í„´ ì œê±° (ë” ë‹¤ì–‘í•œ í˜•íƒœ ì§€ì›)
    query = re.sub(r"(ìœ„ì¹˜|ì£¼ì†Œ|ì–´ë””|ì •ë³´|ë¦¬ë·°|í‰ì ).*", "", query).strip()
    
    return query

def search_restaurant(df_restaurants, query):
    """
    ì‚¬ìš©ì ì…ë ¥ì´ ë ˆìŠ¤í† ë‘ ì´ë¦„ê³¼ ì •í™•íˆ ì¼ì¹˜í•˜ë©´ í•´ë‹¹ ì •ë³´ë¥¼ ë°˜í™˜
    """
    query = preprocess_query(query)  # ê²€ìƒ‰ì–´ ì •ì œ

    # 1ì°¨ ê²€ìƒ‰: ì •í™•í•œ ì´ë¦„ í¬í•¨ ì—¬ë¶€
    matching_rows = df_restaurants[df_restaurants["ì´ë¦„"].str.contains(query, case=False, na=False)]

    # 2ì°¨ ê²€ìƒ‰: ë¶€ë¶„ ì¼ì¹˜ í—ˆìš© (ì˜ˆ: "ìƒëŸ¬ë””"ë§Œ ì…ë ¥í•´ë„ "ìƒëŸ¬ë”” ì¸ì²œëŒ€ì " ê²€ìƒ‰ë¨)
    if matching_rows.empty:
        matching_rows = df_restaurants[df_restaurants["ì´ë¦„"].apply(lambda x: query in x)]
    
    if not matching_rows.empty:
        row = matching_rows.iloc[0]  # ì²« ë²ˆì§¸ ê²€ìƒ‰ ê²°ê³¼ ì„ íƒ
        response = (
            f"{row['ì´ë¦„']}\n"
            f"ğŸ“ ìœ„ì¹˜: {row['ì£¼ì†Œ']}\n"
            f"â­ í‰ì : {row['í‰ì ']}ì \n"
            f"ğŸ“ ì£¼ìš” ë¦¬ë·°: {row['ì£¼ìš” ë¦¬ë·°']}"
        )
        return response
    return "âŒ í•´ë‹¹ ë ˆìŠ¤í† ë‘ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."

# ì‹¤í–‰ ì˜ˆì œ
file_path = "restaurants.txt"  # íŒŒì¼ëª… ì„¤ì •
if not os.path.exists(file_path):
    print(f"âŒ ì˜¤ë¥˜: '{file_path}' íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
else:
    df_restaurants = parse_restaurants_from_txt(file_path)
    
    # ë°ì´í„°í”„ë ˆì„ ì¶œë ¥
    print(df_restaurants)

    # CSV íŒŒì¼ë¡œ ì €ì¥
    output_file = "restaurants_clean.csv"
    df_restaurants.to_csv(output_file, index=False, encoding="utf-8-sig")
    print(f"âœ… ë ˆìŠ¤í† ë‘ ë°ì´í„°ê°€ '{output_file}' íŒŒì¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # ì˜ˆì œ ê²€ìƒ‰ ì‹¤í–‰
    queries = ["ìƒëŸ¬ë”” ì¸ì²œëŒ€ì ", "ìº¡í‹´ ë£¨ì´"]
    for query in queries:
        response = search_restaurant(df_restaurants, query)
        print(response)

# Q1. ìº¡í‹´ ë£¨ì´ì˜ ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?
# Q2. ìº¡í‹´ ë£¨ì´ì˜ ì£¼ìš” ë©”ë‰´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
# Q3. ìº¡í‹´ ë£¨ì´ì˜ ë¶„ìœ„ê¸°ëŠ” ì–´ë–¤ê°€ìš”?
# Q4. ìº¡í‹´ ë£¨ì´ì˜ ëŒ€í‘œì ì¸ ë¦¬ë·°ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
# Q5. ìº¡í‹´ ë£¨ì´ì—ì„œ ì¶”ì²œí•˜ëŠ” ìŒì‹ì€ ë¬´ì—‡ì¸ê°€ìš”?
# ìƒëŸ¬ë”” ì¸ì²œëŒ€ì 

# Q6. ìƒëŸ¬ë”” ì¸ì²œëŒ€ì ì˜ ìœ„ì¹˜ê°€ ì–´ë””ì¸ê°€ìš”?
# Q7. ìƒëŸ¬ë”” ì¸ì²œëŒ€ì ì˜ í‰ì ì€ ëª‡ ì ì¸ê°€ìš”?
# Q8. ìƒëŸ¬ë”” ì¸ì²œëŒ€ì ì˜ ì•¼ì±„ ì‹ ì„ ë„ëŠ” ì–´ë–¤ê°€ìš”?
# Q9. ìƒëŸ¬ë”” ì¸ì²œëŒ€ì ì—ì„œ ê°€ì¥ ì¸ê¸°ê°€ ë§ì€ ë©”ë‰´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
# Q10. ìƒëŸ¬ë”” ì¸ì²œëŒ€ì  ë°©ë¬¸ ì‹œ ì£¼ì˜í•  ì ì´ ìˆë‚˜ìš”?
# ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„

# Q11. ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„ì˜ ìœ„ì¹˜ëŠ” ì–´ë””ì¸ê°€ìš”?
# Q12. ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„ì˜ ë²„ê±° ë§›ì€ ì–´ë–¤ê°€ìš”?
# Q13. ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„ì˜ ê°€ê²©ëŒ€ëŠ” ì–´ëŠ ì •ë„ì¸ê°€ìš”?
# Q14. ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„ì˜ ê³ ê° ì„œë¹„ìŠ¤ëŠ” ì–´ë–¤ê°€ìš”?
# Q15. ë²ˆíŒ¨í‹°ë²ˆ ì†¡ë„ì˜ ëŒ€í‘œì ì¸ ë¦¬ë·°ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.
# ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì 

# Q16. ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì ì˜ ìœ„ì¹˜ëŠ” ì–´ë””ì¸ê°€ìš”?
# Q17. ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì ì˜ ì‚¼ê²¹ì‚´ ë§›ì€ ì–´ë–¤ê°€ìš”?
# Q18. ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì ì—ì„œ ì¶”ê°€ ë¹„ìš©ì´ ë°œìƒí•˜ëŠ” í•­ëª©ì€ ë¬´ì—‡ì¸ê°€ìš”?
# Q19. ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì ì˜ ê³ ê° ì„œë¹„ìŠ¤ í‰ê°€ëŠ” ì–´ë–¤ê°€ìš”?
# Q20. ì˜¤ë³µì†¥ëšœê»‘ ì†¡ë„ì ì˜ ëŒ€í‘œì ì¸ ë¦¬ë·°ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
# ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„

# Q21. ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„ì˜ ìœ„ì¹˜ëŠ” ì–´ë””ì¸ê°€ìš”?
# Q22. ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„ì—ì„œ ì¸ê¸° ìˆëŠ” ë©”ë‰´ëŠ” ë¬´ì—‡ì¸ê°€ìš”?
# Q23. ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„ì˜ ê°€ê²©ëŒ€ëŠ” ì–´ë–»ê²Œ ë˜ë‚˜ìš”?
# Q24. ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„ì˜ ì£¼ìš” ë¦¬ë·°ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.
# Q25. ì†¡ë„êµ­ì œì‹ ë„ì‹œ ì†¡ë„ê°ˆë¹„ì—ì„œ ì§ì›ë“¤ì´ ì§ì ‘ ê³ ê¸°ë¥¼ êµ¬ì›Œì£¼ë‚˜ìš”?